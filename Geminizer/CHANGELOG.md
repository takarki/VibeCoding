# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [0.9.34] - 2025-12-29

### ♻️ Refactored - コード品質の大幅改善

#### 構造の修正
- **src/ディレクトリの作成と必要ファイルの実装**
  - manifest.jsonで参照されていたが存在しなかった致命的な問題を解決
  - background.js - メッセージルーティング、タブ管理
  - ai_injector.js - Geminiプロンプト注入機能
  - content_extractor.js - ページコンテンツ抽出
  - full_page_capture.js - フルページスクリーンショット
  - gemini_enhancer.js - Gemini UI改善機能
  - youtube_button_injector.js - YouTube要約ボタン

#### 共通モジュールの作成
- **constants.js** - 定数の一元管理
  - バージョン、URL、タイムアウト値
  - ストレージキー、モデルモード定義
  - マジックナンバーの排除

- **storage-utils.js** - ストレージユーティリティ
  - chrome.storage操作の共通化
  - クォータエラーの自動処理
  - 安全なストレージ操作ヘルパー

- **validation-utils.js** - バリデーションユーティリティ
  - プロンプト検証
  - URL・ショートカットキー検証
  - 入力データのサニタイズ

#### コード品質の向上
- popup.jsとoptions.jsの重複コード削除（DRY原則準拠）
- popup.js.backupファイルを削除
- エラーハンドリングの統一化
- 大規模関数の分割（単一責任の原則）

### 📚 Documentation
- PROJECT_STRUCTURE.mdを更新
- 新しいユーティリティファイルの説明を追加

## [0.9.33] - 2025-12-23

### Fixed
- **Gemini 3モデル切り替え機能の修正**
  - Gemini 3の新UI（2025年11月リリース）に対応
  - test-idマッピングを更新: `experimental` → `思考モード`, `standard` → `高速モード`
  - ボタン検出ロジックを改善: 無効化されたボタンを除外するように修正
  - メニュー表示待機ロジックをsetTimeoutからMutationObserverに変更（より確実に動作）
  - デバッグログを強化して問題の診断を容易に

### Technical Details
- `ai_injector.js`の`switchModel`関数を全面的に改善
- メニューパネルの検出に複数のセレクタを使用
- 最大3秒間メニューの出現を待機（以前は0.8秒）
- モデルセレクタボタンの検出条件を厳格化

## [1.0.0] - 2024-12-21

### 🎉 メジャーリリース - リファクタリングと新機能追加

### ♻️ Changed - リファクタリング
- **プロジェクト構造の大幅な改善**:
  - すべてのソースコードファイルを `src/` ディレクトリに移動
  - すべてのUI関連ファイルを `ui/` ディレクトリに移動
  - すべてのドキュメントを `docs/` ディレクトリに移動
  - ルートディレクトリをクリーンアップし、整理された構造に

- **ファイルパスの更新**:
  - `manifest.json` の content_scripts パスを更新 (`src/` プレフィックス追加)
  - `manifest.json` の background service worker パスを更新
  - `manifest.json` の popup と options ページパスを更新 (`ui/` プレフィックス追加)
  - `background.js` 内の script injection パスを更新
  - `popup.js` 内の script injection パスを更新

- **バージョン管理の改善**:
  - バージョンを 0.9.17 から 1.0.0 にアップグレード
  - セマンティックバージョニングに準拠

### ✨ Added - 新機能

- **新プロンプトテンプレート追加** (3種類):

  1. **文系新卒1年目向け詳細解説プロンプト**:
     - 専門用語を初心者にもわかりやすく徹底解説
     - 実務での活用例を新卒1年目の視点で提示
     - よくある誤解・つまずきポイントを先回り
     - モチベーション維持のための段階的な構成
     - 絵文字を活用した視覚的にわかりやすい出力

  2. **DeepResearch業界分析プロンプト**:
     - Deep Research ツールを自動アクティブ化
     - 業界概況、競合環境、技術動向を包括的に分析
     - SWOT分析、ファイブフォース分析、PEST分析を実施
     - 将来展望とシナリオプランニング
     - 戦略的示唆とアクションアイテムの提示
     - Markdown 表形式での視覚的なレポート出力

  3. **詳細記事録作成プロンプト**:
     - 記事を構造化してナレッジベース化
     - メタ情報、タグ、キーワードで検索性向上
     - 一文要約、3行サマリーで素早い復習が可能
     - データ・統計情報を整理してリスト化
     - 個人的インサイトと考察を分離して記録
     - アクションアイテムで実践的な次のステップを提示
     - Second Brain / Zettelkasten に最適な形式

- **デフォルトプロンプトファイルの作成**:
  - `src/default-prompts.js` を作成
  - 全プロンプトを一元管理
  - 将来的な拡張性を向上

- **プロジェクト構造ドキュメントの追加**:
  - `docs/PROJECT_STRUCTURE.md` を作成
  - ディレクトリ構成の詳細説明
  - 主要コンポーネントの役割を明記
  - データフローの図解
  - 開発とビルドのガイド

### 📝 Documentation

- **README.md の更新**:
  - バージョンバッジを 1.0.0 に更新
  - 新機能3種類をハイライト表示
  - デフォルトプロンプト数を8種類から11種類に更新
  - 変更履歴セクションを追加

- **CHANGELOG.md の大幅な改善**:
  - Keep a Changelog フォーマットに準拠
  - セマンティックバージョニングの採用を明記
  - 絵文字で視覚的にわかりやすく
  - カテゴリ別に整理（Changed, Added, Fixed, Documentation）

### 🐛 Fixed

- **ファイルパス参照の修正**:
  - `background.js` の `content_extractor.js` パス修正
  - `background.js` の `ai_injector.js` パス修正
  - `popup.js` の `full_page_capture.js` パス修正

- **ストレージエラーハンドリングの改善**:
  - エラー時のフォールバック処理を強化
  - デフォルトプロンプトの読み込みロジックを改善

### 🎯 Impact

この1.0.0リリースにより:
- **保守性が大幅に向上**: 整理されたフォルダ構造により、開発者が迷わずファイルを見つけられる
- **拡張性が向上**: 新機能の追加が容易に
- **ユーザー体験の向上**: 3つの新プロンプトにより、より多様なユースケースに対応
- **ドキュメントの充実**: 新規開発者のオンボーディングが容易に

---

## [0.9.17] - 2024-12-21

### Fixed
- options.jsの`loadPrompts`関数の過剰なエラーハンドリングを修正
  - ストレージエラー時に自動的にクリアして再初期化していた問題を修正
  - 既存のプロンプトデータを保護し、エラー時もデータを保持するように改善
  - これにより、プロンプトが消失する問題が解消されました

## [0.9.16] - 2024-12-21

### Fixed
- popup.jsの構文エラーを修正
  - 97行目のテンプレートリテラルの閉じバッククォートを追加
  - これにより`Uncaught SyntaxError: Unexpected identifier '#システムプロンプト'`エラーが解消されました
  
- YouTube履歴ページでのサムネイルボタン表示ロジックを改善
  - サムネイル画像要素を直接検出して、その親コンテナを特定するロジックに変更
  - 画像要素の親を遡って適切なpositionedコンテナを探すロジックを追加
  - ボタンの挿入ロジックをシンプル化し、確実にDOMに追加されるように改善
  - より詳細なデバッグログを追加

## [0.9.15] - 2024-12-21

### Fixed
- popup.jsの構文エラーを修正
  - 97行目のバッククォート内のバッククォートエスケープ問題を修正
  - `<!DOCTYPE html>`のバッククォートを削除して構文エラーを解消
  
- YouTube履歴ページでのサムネイルボタン表示を大幅改善
  - `ytd-video-meta-block`内のサムネイル要素を複数のセレクタで検出
  - 画像要素の親コンテナにボタンを挿入するロジックを追加
  - 親コンテナのpositionスタイルも設定して確実に表示
  - より詳細なデバッグログを追加

## [0.9.14] - 2024-12-21

### Fixed
- YouTube履歴ページでのサムネイルボタン表示を改善
  - `ytd-video-meta-block`コンテナ内のサムネイル要素を検出するロジックを追加
  - 親要素を遡ってコンテナを探すロジックを追加
  - ボタンをコンテナの最初に挿入して確実に表示されるように改善
  - コンテナ検出のデバッグログを追加（失敗時の詳細ログ）
  
- popup.jsのエラーハンドリングを改善
  - `loadPrompts`のエラーをキャッチしてユーザーに表示
  - 初期化時のエラーをキャッチしてエラーメッセージを表示
  - これにより、問題が発生した場合にユーザーが状況を把握できるようになりました

## [0.9.13] - 2024-12-21

### Added
- プロンプト読み込みとUI更新のデバッグログを追加
  - `popup.js`の`loadPrompts`関数に詳細なログを追加
  - DOMContentLoaded、ストレージ取得、UI更新の各段階でログを出力
  - オプションボタンクリック時のログを追加
  - これにより、問題の診断が容易になります

## [0.9.12] - 2024-12-20

### Fixed
- プロンプト読み込み問題を根本的に修正
  - `relevantChange`チェックを完全に削除して元のシンプルな実装に戻す
  - Throttle処理を削除して即座に処理を実行
  - 監視開始の遅延を削除して即座に監視を開始
  - これにより、プロンプト読み込みが正常に動作するようになりました
  
- YouTubeサムネイルボタンのデバッグログを追加
  - ボタン注入プロセスの詳細なログを追加
  - 問題の診断を容易にするため

## [0.9.11] - 2024-12-20

### Fixed
- プロンプト読み込み問題を修正（試行1）
  - MutationObserverの`relevantChange`チェックを緩和
  - プロンプトエリアが既に存在する場合も処理を実行するように改善
  - 監視開始の遅延時間を短縮（2秒→1秒、既読時は0.5秒）
  - Throttle間隔を調整（500ms→300ms）して応答性を向上
  
- YouTubeサムネイルボタンの位置を変更
  - 右上から左上に変更してYouTubeの本来の機能との競合を回避
  - より確実に表示されるように改善

## [0.9.10] - 2024-12-20

### Fixed
- YouTubeサムネイルボタンのコードで変数重複宣言エラーを修正
  - `videoUrl`変数の重複宣言を削除
  - コードの重複部分を整理

## [0.9.9] - 2024-12-20

### Fixed
- Geminiページの読み込みが止まる問題を修正
  - MutationObserverにthrottle処理を追加（500ms間隔）してパフォーマンスを改善
  - 監視範囲を最適化（プロンプトエリア関連の変更のみ処理）
  - 監視開始を遅延実行（2秒後）してGeminiの初期読み込みを妨げないように改善
  - Enterキー処理を最適化（送信ボタンが存在する場合のみ処理）
  - 不要な属性・テキスト変更の監視を無効化してパフォーマンスを向上

## [0.9.8] - 2024-12-20

### Fixed
- YouTube履歴ページでのサムネイルボタン表示を修正
  - 履歴ページ用のセレクタを追加（`ytd-video-meta-block`など）
  - URL抽出ロジックを改善（`?v=VIDEO_ID`の部分を正しく保持）
  - URLパース処理を改善し、無効なURLをスキップ
  - サムネイルコンテナ検出ロジックを改善（履歴ページの構造に対応）
  - デバッグログを追加

## [0.9.7] - 2024-12-20

### Fixed
- Canvasツール用プロンプトを修正
  - Canvasツールが有効な場合、実際に動作するHTMLコードを直接出力するように変更
  - 「構成案」ではなく「完全なHTMLコード」を生成するように指示を明確化
  - `<!DOCTYPE html>`から始まる完全なHTMLドキュメントとして出力するよう指定
  
- NanoBananaツール用プロンプトを修正
  - NanoBananaツールが有効な場合、図解を画像として生成するように変更
  - テキストベースの説明ではなく、実際の図解画像を出力するように指示を明確化
  
- YouTubeサムネイルボタンの検出ロジックを改善
  - リンク要素から直接探す方式に変更
  - より確実にサムネイルコンテナを見つけるように改善
  - 重複防止のためのURLトラッキング機能を追加

## [0.9.6] - 2024-12-20

### Added
- YouTubeサムネイルに「要約」ボタンを追加
  - 検索結果、おすすめ動画、プレイリストなどのサムネイルにボタンを表示
  - 動画ページに遷移せずに要約を開始可能

### Fixed
- NanoBananaのツール自動アクティブ化機能を改善
  - 「画像を作成」ラベルで検索する機能を追加（日本語版Gemini対応）
  - メニューが完全に読み込まれるまで待機する処理を追加
  - より広範囲のセレクタでボタンを検索
  - デバッグログを強化（メニューのHTML構造も出力）

## [0.9.5] - 2024-12-20

### Fixed
- NanoBananaのツール自動アクティブ化機能を改善
  - アイコン名が見つからない場合、ラベルテキスト（"NanoBanana"）で検索する機能を追加
  - デバッグログを追加して、メニュー内の利用可能なアイコンとボタンを表示
  - より柔軟な検索方法を実装

## [0.9.4] - 2024-12-20

### Fixed
- `chrome.commands.update`エラーを完全に修正（エラーをスローしないように変更）
- 保存処理が確実に完了するようにエラーハンドリングを改善

## [0.9.3] - 2024-12-20

### Added
- プロンプト保存時の「保存されました」メッセージ表示機能を実装
- デフォルトプロンプトにツール設定を追加
  - 「インフォグラフィック構成案」: CanvasをデフォルトでON
  - 「NanoBanana Pro 図解作成」: NanoBananaをデフォルトでON

### Fixed
- `chrome.commands.update`エラーを修正（このAPIは存在しないため、エラーを無視するように変更）
- 保存メッセージのエラー時の表示処理を修正
- デフォルトプロンプトにtoolsプロパティを追加（popup.jsとoptions.jsの両方）
- ショートカットコマンド更新処理を非同期エラーハンドリングで保護

## [0.9.2] - 2024-12-20

### Fixed
- ツール自動アクティブ化機能のさらなる改善
  - ツールボタンの検出ロジックを強化
  - 複数のセレクタパターンに対応
  - より詳細なログ出力を追加

## [0.9.1] - 2024-12-20

### Added
- NanoBananaをツールショートカットに追加
- プロンプト編集画面にツール自動アクティブ化オプションを追加
  - DeepResearch、Canvas、NanoBananaを個別に選択可能
  - プロンプト実行時に選択したツールを自動的にアクティブ化
  - 複数選択時は最初に選択されたツールがアクティブ化される
- プロンプト保存時に「保存されました」メッセージを表示

### Fixed
- ツール自動アクティブ化機能の改善
  - リトライロジックを追加（最大10回、500ms間隔）
  - より堅牢なセレクタを使用してツールボタンを検索
  - ページ読み込み完了を待つ処理を追加（1.5秒遅延）
  - ツールメニューの検出とクリック処理を改善

## [0.9.0] - 2024-12-20

### Added
- Gemini UI改善機能を追加
  - Enterキーの動作変更: Enter=改行、Shift+Enter/Ctrl+Enter=送信
  - ツールショートカット: DeepResearchとCanvasへのショートカットボタンをプロンプトバーに追加
  - コンテンツ幅のカスタマイズ: Geminiのコンテンツ幅を自由に調整可能（デフォルト: 1200px）
  - オプションページに「Gemini UI改善設定」セクションを追加
  - すべての機能はデフォルトでON（既存ユーザーにも自動適用）
- 新規ファイル: `gemini_enhancer.js` - GeminiページでのUI改善機能を実装

### Changed
- `manifest.json`に`content_scripts`を追加（Geminiページでの自動実行）
- 設定データ構造: `geminiUIEnhancements`キーでGemini UI改善設定を管理

### Technical
- Enhancer4Googleの機能を統合・適応
- `ai_injector.js`との競合を回避する仕組みを実装
- 設定は`chrome.storage.sync`で同期保存

## [0.8.1] - 2024-12-03

### Reverted
- YouTube要約ボタンのExtension context invalidated対応を切り戻し
  - 修正が期待通りに動作しなかったため、以前の安定版に戻しました
  - YouTube要約ボタンは拡張機能の再読み込み後にページリロードが必要です

### Note
- ショートカットキー機能（Ctrl+Shift+U）は引き続き利用可能です
- ポップアップからの要約実行は正常に動作します

## [0.8.0] - 2024-12-03

### Fixed
- YouTube要約ボタンが機能しなくなる問題を修正
  - Extension context invalidatedエラーを適切に処理
  - 拡張機能の再読み込み時にコンテキストの有効性をチェック
  - エラーメッセージを改善し、ユーザーにページ再読み込みを促す
- ショートカットキー機能のエラーハンドリングを改善
  - 詳細なデバッグログを追加
  - エラー時に通知を表示

### Added
- ショートカットキー機能を追加
  - YouTube要約用のデフォルトショートカット: `Ctrl+Shift+U` (Mac: `Command+Shift+U`)
  - 各プロンプトにカスタムショートカットキーを設定可能
  - Chromeのデフォルトショートカットとの競合検出機能

### Changed
- バージョンを0.8.0に戻す
- バージョン管理ルールを明確化（MAJOR.MINOR.PATCH形式）

---

## バージョン管理ルール

### バージョン番号の形式
- **MAJOR**: 互換性を壊す大きな変更（API変更、構成の大幅な変更など）
- **MINOR**: 後方互換性のある新機能追加
- **PATCH**: バグ修正、小さな改善

### 更新時の注意事項
1. 変更を加えたら必ずCHANGELOG.mdを更新する
2. manifest.jsonのバージョン番号を更新する
3. 変更内容を適切なカテゴリ（Added/Changed/Fixed/Removed）に分類する
4. 日付を記録する

